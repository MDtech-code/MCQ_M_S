{% extends 'base/base.html' %}
{% load static %}

{% block title %}Student Progress - MCQ Master{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  .chart-container {
    max-width: 600px;
    margin: 2rem auto;
  }
  .feedback-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="text-center mb-4">Your Progress Dashboard</h2>
  
  {% for item in progress %}
    <div class="card mb-4">
      <div class="card-header">
        <h3>{{ item.subject }}</h3>
      </div>
      <div class="card-body">
        <p><strong>Total Attempts:</strong> {{ item.total_attempts }}</p>
        <p><strong>Average Score:</strong> {{ item.average_score|floatformat:1 }}%</p>
        <p><strong>Strengths:</strong> {% for topic in item.strength_topics %}{{ topic }}{% if not forloop.last %}, {% endif %}{% empty %}None{% endfor %}</p>
        <p><strong>Weaknesses:</strong> {% for topic in item.weakness_topics %}{{ topic }}{% if not forloop.last %}, {% endif %}{% empty %}None{% endfor %}</p>
        <div class="feedback-card mt-3">
          <h5>Feedback</h5>
          <p>{{ item.feedback|linebreaks }}</p>
        </div>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="scoreChart-{{ item.subject|slugify }}"></canvas>
    </div>
  {% empty %}
    <div class="alert alert-info text-center">
      No progress data available. Take some tests to see your analytics!
    </div>
  {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    {% for item in progress %}
      const history = {{ history|safe }}.filter(h => h.subject === '{{ item.subject }}');
      const labels = history.map(h => new Date(h.completed_at).toLocaleDateString());
      const scores = history.map(h => h.score);

      new Chart(document.getElementById('scoreChart-{{ item.subject|slugify }}'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Score Over Time',
            data: scores,
            borderColor: '#007bff',
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { min: 0, max: 100, title: { display: true, text: 'Score (%)' } },
            x: { title: { display: true, text: 'Date' } }
          }
        }
      });
    {% endfor %}
  });
</script>
{% endblock %}